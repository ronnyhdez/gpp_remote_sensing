---
title: "Results and conclussions"
description: |
  MODIS products can understimate GPP in Santa Rosa National Park Tropical Dry Forest
site: distill::distill_website
output:
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(readr)
library(dplyr)
library(ggplot2)
library(janitor)
library(lubridate)
library(visdat)
library(corrplot)
library(tidyr)
library(rmarkdown)
library(tidymodels)


precipitation <- 
  read_csv("data/hardvard_dataverse_tropidry/Daily_Precipitation_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd(date),
         do_y = as.numeric(do_y),
         precip = as.numeric(precip))

biomet <- 
  read_csv("data/hardvard_dataverse_tropidry/Micrometeorological_Biomet_Parameters_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd_hm(date)) %>% 
  mutate(across(where(is.character), as.numeric))

monthly_gpp <- 
  read_csv("data/hardvard_dataverse_tropidry/Monthly_NEE_GPP_Reco_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  unite(col = date, year, month, sep = "-") %>% 
  mutate(date = paste0(date, "-1"),
         date = ymd(date)) %>% 
  select(-date_1, -date_2) %>% 
  mutate(across(where(is.character), as.numeric))

ndvi_moha <- 
  readxl::read_xlsx("data/hardvard_dataverse_tropidry/final -NDVI- smoothed -complete.xlsx") %>% 
  clean_names()

modis_gpp <- 
  read_csv("data/modis-gpp-sr/modis-sr-MYD17A2H-006-results.csv") %>% 
  clean_names() %>% 
  select(date, myd17a2h_006_gpp_500m, 
         myd17a2h_006_psn_qc_500m_modland_description,
         myd17a2h_006_psn_qc_500m_cloud_state_description,
         myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  rename(gpp = myd17a2h_006_gpp_500m,
         modland_description = myd17a2h_006_psn_qc_500m_modland_description,
         cloud_state_description = myd17a2h_006_psn_qc_500m_cloud_state_description,
         scf_qc_description = myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  mutate(gpp = gpp * 10)

modis_indices <- 
  read_csv("data/modis-indices-sr/modis-indices-sr-MOD13Q1-006-results.csv") %>% 
  clean_names() %>% 
  select(date, mod13q1_006_250m_16_days_evi, 
         mod13q1_006_250m_16_days_ndvi, 
         mod13q1_006_250m_16_days_vi_quality,
         mod13q1_006_250m_16_days_pixel_reliability,
         mod13q1_006_250m_16_days_pixel_reliability_modland_description) %>% 
  rename(evi = mod13q1_006_250m_16_days_evi,
         ndvi = mod13q1_006_250m_16_days_ndvi,
         vi_quality = mod13q1_006_250m_16_days_vi_quality,
         pixel_reliability = mod13q1_006_250m_16_days_pixel_reliability,
         reliability_modland_description =
           mod13q1_006_250m_16_days_pixel_reliability_modland_description)
```

<!-- 5. Results (including Discussion ~500 words) -->

<!-- Results and Discussion – Be selective and only show a reasonable number of  -->
<!-- quality graphs that describe your results. Discuss each graph (or group of  -->
<!-- graphs) with a separate paragraph that makes references to the figures (or  -->
<!-- tables) that you are talking about. Tell people what they see in the graph,  -->
<!-- point out interesting relationships, explain how they can be biologically  -->
<!-- interpreted, and/or what the practical applications of these findings are. -->

<!-- [For the draft submission, you are somewhat limited to complete this section. -->
<!-- You may apply what you learned in Labs 1 through 5 where applicable and useful. -->
<!-- Leave the rest for completion for the final submission. If you have some ideas  -->
<!-- which advanced multivariate methods you want to use here, you can briefly  -->
<!-- describe your plans to receive some feedback on that.] -->

<!-- Conclusions, About, References – You may add these as additional pages,  -->
<!-- paragraphs or footnotes.  -->

## Results

```{r fig.cap = "GPP trends over the years for MODIS and in-situ data. Despite having similar trends, range is higher for in-situ data than the MODIS derived GPP"}
# Plot with both GPP's
rec_monthly_gpp <- monthly_gpp %>% 
  select(date, average_gpp) %>% 
  rename(gpp = average_gpp) %>% 
  mutate(origin = "in_situ")

rec_modis_gpp <- modis_gpp %>% 
  select(date, gpp) %>% 
  mutate(date = floor_date(date, "month")) %>% 
  group_by(date) %>% 
  summarise(
    gpp = mean(gpp, na.rm = TRUE)
  ) %>% 
  mutate(origin = "modis") %>% 
  filter(date > ymd("2013-04-30"))

rec_both <- bind_rows(rec_monthly_gpp, rec_modis_gpp)

rec_both %>% 
  ggplot(aes(x = date, y = gpp, group = origin)) +
  geom_line(aes(color = origin), size = 1) +
  theme_linedraw(base_size = 12) +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 70, h = 1)) +
  labs(x = "Date", y = "GPP (mgm-2s-1)", color = "GPP source")
```

#### Regression trees

This section is still a **Work In Progress**. The objective is to apply a
regression Random Forest using the meteorological variables as predictors of 
GPP. After the evaluation of the predictions also a variable importance
analysis will be run.

Given that GPP observations are monthly, this reduces the total amount of 
observations available, so bootstrapping is applied to the regression random
forest.

```{r}
ndvi_summarized <- ndvi_moha %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    ndvi_mean = mean(ndvi, na.rm = TRUE),
    ndvi_sd = sd(ndvi, na.rm = TRUE)
  )

biomet_summarized <- biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    # sd_par_incoming = sd(par_incoming, na.rm = TRUE), 
    # sd_swc          = sd(swc, na.rm = TRUE), 
    # sd_vpd          = sd(vpd, na.rm = TRUE), 
    # sd_r_h          = sd(r_h, na.rm = TRUE), 
    # sd_tair         = sd(tair, na.rm = TRUE), 
    # sd_nee          = sd(nee, na.rm = TRUE), 
    # sd_le           = sd(le, na.rm = TRUE), 
    # sd_h            = sd(h, na.rm = TRUE),
    mean_par_incoming = sd(par_incoming, na.rm = TRUE), 
    mean_swc          = sd(swc, na.rm = TRUE), 
    mean_vpd          = sd(vpd, na.rm = TRUE), 
    mean_r_h          = sd(r_h, na.rm = TRUE), 
    mean_tair         = sd(tair, na.rm = TRUE), 
    # mean_nee          = sd(nee, na.rm = TRUE), 
    mean_le           = sd(le, na.rm = TRUE), 
    mean_h            = sd(h, na.rm = TRUE)
  )

summarize_dataset <- monthly_gpp %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  inner_join(ndvi_summarized) %>% 
  inner_join(biomet_summarized) %>% 
  drop_na()

set.seed(123)
gpp_split <- initial_split(summarize_dataset)
gpp_train <- training(gpp_split)
gpp_test <- testing(gpp_split)

set.seed(123)
gpp_boot <- bootstraps(gpp_train)
gpp_boot

rf_spec <- rand_forest() %>%
  set_mode("regression") %>%
  set_engine("ranger")

rf_spec

gpp_wf <- workflow() %>%
  add_formula(average_gpp ~ .)

gpp_wf


rf_rs <- gpp_wf %>%
  add_model(rf_spec) %>%
  fit_resamples(
    resamples = gpp_boot,
    control = control_resamples(save_pred = TRUE)
  )

rf_rs


## Evaluate model
collect_metrics(rf_rs)
```


## Conclusions




## References

 > James, G., Witten, D., Hastie, T., & Tibshirani, R. (2013). An introduction to statistical learning (Vol. 112, p. 18). New York: springer.
