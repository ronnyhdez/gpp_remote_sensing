---
title: "Results and conclussions"
description: |
  MODIS products can understimate GPP in Santa Rosa National Park Tropical Dry Forest
site: distill::distill_website
output:
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
editor_options: 
  markdown: 
    wrap: 80
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Libraries
library(readr)
library(dplyr)
library(ggplot2)
library(janitor)
library(lubridate)
library(visdat)
library(corrplot)
library(tidyr)
library(rmarkdown)
library(tidymodels)
library(report)
library(cowplot)

# Import data sets
precipitation <- 
  read_csv("data/hardvard_dataverse_tropidry/Daily_Precipitation_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd(date),
         do_y = as.numeric(do_y),
         precip = as.numeric(precip))

biomet <- 
  read_csv("data/hardvard_dataverse_tropidry/Micrometeorological_Biomet_Parameters_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd_hm(date)) %>% 
  mutate(across(where(is.character), as.numeric))

monthly_gpp <- 
  read_csv("data/hardvard_dataverse_tropidry/Monthly_NEE_GPP_Reco_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  unite(col = date, year, month, sep = "-") %>% 
  mutate(date = paste0(date, "-1"),
         date = ymd(date)) %>% 
  select(-date_1, -date_2) %>% 
  mutate(across(where(is.character), as.numeric))

ndvi_moha <- 
  readxl::read_xlsx("data/hardvard_dataverse_tropidry/final -NDVI- smoothed -complete.xlsx") %>% 
  clean_names()

modis_gpp <- 
  read_csv("data/modis-gpp-sr/modis-sr-MYD17A2H-006-results.csv") %>% 
  clean_names() %>% 
  select(date, myd17a2h_006_gpp_500m, 
         myd17a2h_006_psn_qc_500m_modland_description,
         myd17a2h_006_psn_qc_500m_cloud_state_description,
         myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  rename(gpp = myd17a2h_006_gpp_500m,
         modland_description = myd17a2h_006_psn_qc_500m_modland_description,
         cloud_state_description = myd17a2h_006_psn_qc_500m_cloud_state_description,
         scf_qc_description = myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  mutate(gpp = gpp * 10)

modis_indices <- 
  read_csv("data/modis-indices-sr/modis-indices-sr-MOD13Q1-006-results.csv") %>% 
  clean_names() %>% 
  select(date, mod13q1_006_250m_16_days_evi, 
         mod13q1_006_250m_16_days_ndvi, 
         mod13q1_006_250m_16_days_vi_quality,
         mod13q1_006_250m_16_days_pixel_reliability,
         mod13q1_006_250m_16_days_pixel_reliability_modland_description) %>% 
  rename(evi = mod13q1_006_250m_16_days_evi,
         ndvi = mod13q1_006_250m_16_days_ndvi,
         vi_quality = mod13q1_006_250m_16_days_vi_quality,
         pixel_reliability = mod13q1_006_250m_16_days_pixel_reliability,
         reliability_modland_description =
           mod13q1_006_250m_16_days_pixel_reliability_modland_description)

## Filter observations with good quality
## This takes from 94 observations to 53 observations. Remove 41 observations
modis_indices_clean <- modis_indices %>% 
  filter(reliability_modland_description == "Good data, use with confidence") %>% 
  select(date, ndvi, evi) #%>% 
  # mutate(week = week(date),
  #        year = year(date))

## Filter observations with good quality
## This takes from 183 observations to 114. Remove 69 observations.
modis_gpp_clean <- modis_gpp %>% 
  filter(modland_description == "Good quality",
         cloud_state_description == "Significant clouds NOT present (clear)",
         scf_qc_description == "Very best possible") %>% 
  select(date, gpp) #%>% 
  # mutate(week = week(date),
  #        year = year(date))

modis_join <- modis_gpp_clean %>% 
  full_join(modis_indices_clean, by = c("date"))
```

<!-- 5. Results (including Discussion ~500 words) -->

<!-- Results and Discussion – Be selective and only show a reasonable number of  -->

<!-- quality graphs that describe your results. Discuss each graph (or group of  -->

<!-- graphs) with a separate paragraph that makes references to the figures (or  -->

<!-- tables) that you are talking about. Tell people what they see in the graph,  -->

<!-- point out interesting relationships, explain how they can be biologically  -->

<!-- interpreted, and/or what the practical applications of these findings are. -->

<!-- [For the draft submission, you are somewhat limited to complete this section. -->

<!-- You may apply what you learned in Labs 1 through 5 where applicable and useful. -->

<!-- Leave the rest for completion for the final submission. If you have some ideas  -->

<!-- which advanced multivariate methods you want to use here, you can briefly  -->

<!-- describe your plans to receive some feedback on that.] -->

<!-- Conclusions, About, References – You may add these as additional pages,  -->

<!-- paragraphs or footnotes.  -->

## Results

### What is the relation between MODIS products and GPP estimated in-situ?

We have two indices derived from MODIS that can have a relation with the
estimation of GPP in-situ. A linear model was performed to evaluate the 
relation between NDVI with GPP and, EVI with GPP estimated in-situ.

The clean data sets from MODIS products were used here altogether with the GPP
data set with the estimations per month from Santa Rosa National Park.

```{r corr_gpp_modis_in_situ, include = FALSE}
average_gpp <- modis_gpp_clean %>% 
  group_by(zoo::as.yearmon(date)) %>% 
  summarise(
    average_modis_gpp = mean(gpp)
  ) %>% 
  rename(month_year = `zoo::as.yearmon(date)`)

modis_in_situ_gpp <- monthly_gpp %>% 
  mutate(month_year = zoo::as.yearmon(date)) %>% 
  select(month_year, average_gpp) %>% 
  full_join(average_gpp, by = "month_year")

# modis_in_situ_gpp %>% 
#   ggplot(aes(x = average_gpp, y = average_modis_gpp)) +
#   geom_point(color = "#FF3A1D", size = 3.5) +
#   geom_smooth(method = "lm", color = "#4E5C68") +
#   theme_light(base_size = 12) +
#   labs(x = "GPP (mg m-2 s-1)", y = "GPP (mg m-2 s-1)")

# gpp_modis_in_situ <- cor.test(modis_in_situ_gpp$average_gpp,
#                               modis_in_situ_gpp$average_modis_gpp)
```

#### MODIS NDVI and GPP in-situ

Given that observations for GPP in-situ are one per month and we have in most
cases for the same period of time, more than one observation from MODIS, I have
summarized MODIS values with the mean per month. A linear regression was
performed and residuals were evaluated to look for patterns.

```{r linear_models}
## Prepare data for model
ndvi_gpp_in_situ <- modis_indices_clean %>% 
  group_by(zoo::as.yearmon(date)) %>% 
  summarise(
    ndvi_mean = mean(ndvi, na.rm = TRUE),
    evi_mean = mean(evi, na.rm = TRUE)
  ) %>% 
  rename(month_year = `zoo::as.yearmon(date)`) %>%
  full_join(modis_in_situ_gpp, by = "month_year")

## Create the linear models and check results
ndvi_gpp_model <- lm(average_gpp ~ ndvi_mean, data = ndvi_gpp_in_situ)
evi_gpp_model <- lm(average_gpp ~ evi_mean, data = ndvi_gpp_in_situ)

## Report models results
# summary(ndvi_gpp_model)
# report(ndvi_gpp_model)
# plot(evi_gpp_model)
# summary(evi_gpp_model)
# report(evi_gpp_model)
```

```{r fig.cap = "Relation between NDVI and EVI indices derived from MODIS with GPP estimated in-situ"}
ndvi_gpp <- ndvi_gpp_in_situ %>% 
  ggplot(aes(x = ndvi_mean, y = average_gpp)) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  geom_smooth(method = "lm", color = "#4E5C68") +
  theme_light(base_size = 12) +
  labs(x = "MODIS NDVI", y = "GPP (mg m-2 s-1)")

evi_gpp <- ndvi_gpp_in_situ %>% 
  ggplot(aes(x = evi_mean, y = average_gpp)) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  geom_smooth(method = "lm", color = "#4E5C68") +
  theme_light(base_size = 12) +
  labs(x = "MODIS EVI", y = "GPP (mg m-2 s-1)")

## Arrange both plots in one figure:
plot_grid(ndvi_gpp, evi_gpp, labels = c('A', 'B'), label_size = 12)
```

I fitted a linear model (estimated using OLS) to predict GPP in-situ with MODIS
NDVI product (formula: GPP in-situ \~ NDVI) as shown in Figure 1.A. The model 
explains a statistically significant and substantial proportion of variance 
(R2 = 0.84, F(1, 28) = 152.26, p \< .001, adj. R2 = 0.84). The model's intercept, corresponding to NDVI = 0, is at -0.70 (95% CI [-0.89, -0.50], t(28) = -7.35,
p \< .001). Within this model:

-   The effect of NDVI is statistically significant and positive (beta = 1.66,
    95% CI [1.38, 1.94], t(28) = 12.34, p \< .001; Std. beta = 0.92, 95% CI
    [0.77, 1.07])

A second linear model was fitted (estimated using OLS) to predict in-situ GPP 
with MODIS EVI product (formula: GPP in-situ ~ EVI) as shown in Figure 1.B. The model explains a statistically significant and substantial proportion of variance (R2 = 0.79, F(1, 28) = 102.72,
p < .001, adj. R2 = 0.78). The model's intercept, corresponding to EVI = 0, is 
at -0.40 (95% CI [-0.58, -0.22], t(28) = -4.61, p < .001). Within this model:

  - The effect of EVI is statistically significant and positive (beta = 1.95, 
  95% CI [1.56, 2.35], t(28) = 10.14, p < .001; Std. beta = 0.89, 
  95% CI [0.71, 1.07])

For both models, standardized parameters were obtained by fitting the model on 
a standardized version of the dataset. 95% Confidence Intervals (CIs) and 
p-values were computed using the Wald approximation.

##### Residuals exploration

The residuals from both linear models were used to explore any further patterns
in time. Specifically, if there are months in which residuals are larger or
smaller consistently along the time period of this study.

```{r fig.cap = "Residuals values for linear models GPP ~ NDVI (A) and, GPP ~ EVI (B) for registered months", layout="l-body-outset"}
## GPP ~ NDVI residuals %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## Obtain data used in the model (without NA's) to paste residuals and explore
## if there is a pattern of largest residuals in specific months
model_observations <- ndvi_gpp_model[["model"]]
model_residuals <- ndvi_gpp_model[["residuals"]] %>% 
  as.data.frame() %>% 
  rename("residuals" = ".")

# Create dataset
ndvi_observations_residuals <- model_observations %>% 
  left_join(ndvi_gpp_in_situ, by = c("average_gpp", "ndvi_mean")) %>% 
  select(-average_modis_gpp, -evi_mean) %>% 
  bind_cols(model_residuals)

## Plot with distances from zero:
ndvi_residuals <- ndvi_observations_residuals %>% 
  mutate(residuals = round(residuals, digits = 3)) %>% 
  mutate(date = zoo::as.Date(month_year)) %>% 
  ggplot(aes(x = date, y = residuals, label = residuals)) + 
  geom_point(stat = 'identity', color = "#75AADB", size = 9)  +
  geom_hline(yintercept = 0, color = "#4E5C68",
             size = 0.5, linetype = "dashed") +
  scale_x_date(date_labels = "%b-%Y",  date_breaks = "2 month") +
  geom_segment(aes(y = 0, 
                   x = date, 
                   yend = residuals, 
                   xend = date), 
               color = "#75AADB") +
  geom_text(color = "white", size = 2) +
  labs(y = "Residuals GPP ~ MODIS_NDVI",
       x = "Date") + 
  ylim(-0.3, 0.3) +
  theme_light(base_size = 10) +
  coord_flip()

## GPP ~ EVI residuals %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## Obtain data used in the model (without NA's) to paste residuals and explore
## if there is a pattern of largest residuals in specific months
model_observations <- evi_gpp_model[["model"]]
model_residuals <- evi_gpp_model[["residuals"]] %>% 
  as.data.frame() %>% 
  rename("residuals" = ".")

# Create dataset
evi_observations_residuals <- model_observations %>% 
  left_join(ndvi_gpp_in_situ, by = c("average_gpp", "evi_mean")) %>% 
  select(-average_modis_gpp, -evi_mean) %>% 
  bind_cols(model_residuals)

## Plot with distances from zero:
evi_residuals <- evi_observations_residuals %>% 
  mutate(residuals = round(residuals, digits = 3)) %>% 
  mutate(date = zoo::as.Date(month_year)) %>% 
  ggplot(aes(x = date, y = residuals, label = residuals)) + 
  geom_point(stat = 'identity', color = "#75AADB", size = 9)  +
  geom_hline(yintercept = 0, color = "#4E5C68",
             size = 0.5, linetype = "dashed") +
  scale_x_date(date_labels = "%b-%Y",  date_breaks = "2 month") +
  geom_segment(aes(y = 0, 
                   x = date, 
                   yend = residuals, 
                   xend = date), 
               color = "#75AADB") +
  geom_text(color = "white", size = 2) +
  labs(y = "Residuals GPP ~ MODIS_EVI",
       x = "Date") + 
  ylim(-0.3, 0.3) +
  theme_light(base_size = 10) +
  coord_flip() 

## Arrange both plots in one figure:
plot_grid(ndvi_residuals, evi_residuals, labels = c('A', 'B'), label_size = 12)
```

Figure 2 shows the residuals values derived from the linear model between
GPP with NDVI (A), and GPP with EVI (B). No patterns or consistency between
months can be inferred from Figure 2.

##### Residuals and meteorological variables

Given that there is no clear pattern in the values of the residuals with just
the months and years, I made a comparison between the values of the residuals
with meteorological values per month.

 - Do we have meteorological characteristics that are related to larger or 
 shorter residuals values?

In order to check this, a quadratic function was applied to residuals values so
no negative values were in the data set.

```{r}
# Summarise biomet %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
biomet_summarized <- biomet %>% 
  group_by(zoo::as.yearmon(date)) %>% 
  summarise(
    par_incoming = mean(par_incoming, na.rm = TRUE),
    swc = mean(swc, na.rm = TRUE),
    vpd = mean(vpd, na.rm = TRUE),
    r_h = mean(r_h, na.rm = TRUE),
    tair = mean(tair, na.rm = TRUE),
    le = mean(le, na.rm = TRUE),
    h = mean(h, na.rm = TRUE)
  ) %>% 
  rename(month_year = `zoo::as.yearmon(date)`)

# NDVI BIOMET %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## Table with months with higher residuals
## Cuadratic formula to eliminate negative values
observations_residuals <- ndvi_observations_residuals %>% 
  mutate(positive_residuals = residuals ^ 2,
         positive_residuals = round(positive_residuals, digits = 3)) %>% 
  select(month_year, positive_residuals, residuals) %>% 
  arrange(desc(positive_residuals))

ndvi_biomet <- observations_residuals %>% 
  left_join(biomet_summarized, by = "month_year") %>% 
  select(-month_year, -positive_residuals) 

# library(PerformanceAnalytics)
# chart.Correlation(check, histogram = TRUE, method = "pearson")
## Los residuales comparados parecen solo relacionarse con LE.

# EVI BIOMET %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
## Table with months with higher residuals
## Cuadratic formula to eliminate negative values
observations_residuals <- evi_observations_residuals %>% 
  mutate(positive_residuals = residuals ^ 2,
         positive_residuals = round(positive_residuals, digits = 3)) %>% 
  select(month_year, positive_residuals, residuals) %>% 
  arrange(desc(positive_residuals))

## Take biomet variables to validate if there is a similar pattern:
# biomet_summarized is already a created object.
evi_biomet <- observations_residuals %>% 
  left_join(biomet_summarized, by = "month_year") %>% 
  select(-month_year, -positive_residuals) 

## Exploratory PCA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# For EVI
biomet_pca <- evi_biomet %>% 
  # mutate(month_year = as.character(month_year)) %>% 
  # select(-date, -year, -do_y, -hour) %>% 
  drop_na() %>% 
  princomp(cor = T)

biplot(biomet_pca)

# For NDVI
biomet_pca <- ndvi_biomet %>% 
  drop_na() %>% 
  princomp(cor = T)

biplot(biomet_pca)

# library(PerformanceAnalytics)
# chart.Correlation(evi_biomet, histogram = TRUE, method = "pearson")
## Los residuales comparados parecen solo relacionarse con LE (igual que NDVI)
```

### Which meteorological variable have more influence in GPP in-situ?

```{r}

```


### PCA for meteorological variables

TODO: Implement nice PCA plot!!!

```{r}
# nrow(biomet)
# biomet %>% drop_na() %>% nrow()
biomet_pca <- biomet %>% 
  select(-date, -year, -do_y, -hour) %>% 
  drop_na() %>% 
  princomp(cor = T)

# biplot(biomet_pca)
```

### Gradient analysis

```{r}

```

#### Regression trees

This section is still a **Work In Progress**. The objective is to apply a
regression Random Forest using the meteorological variables as predictors of
GPP. After the evaluation of the predictions also a variable importance analysis
will be run.

Given that GPP observations are monthly, this reduces the total amount of
observations available, so bootstrapping is applied to the regression random
forest.

```{r}
ndvi_summarized <- ndvi_moha %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    ndvi_mean = mean(ndvi, na.rm = TRUE),
    ndvi_sd = sd(ndvi, na.rm = TRUE)
  )

biomet_summarized <- biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    # sd_par_incoming = sd(par_incoming, na.rm = TRUE), 
    # sd_swc          = sd(swc, na.rm = TRUE), 
    # sd_vpd          = sd(vpd, na.rm = TRUE), 
    # sd_r_h          = sd(r_h, na.rm = TRUE), 
    # sd_tair         = sd(tair, na.rm = TRUE), 
    # sd_nee          = sd(nee, na.rm = TRUE), 
    # sd_le           = sd(le, na.rm = TRUE), 
    # sd_h            = sd(h, na.rm = TRUE),
    mean_par_incoming = sd(par_incoming, na.rm = TRUE), 
    mean_swc          = sd(swc, na.rm = TRUE), 
    mean_vpd          = sd(vpd, na.rm = TRUE), 
    mean_r_h          = sd(r_h, na.rm = TRUE), 
    mean_tair         = sd(tair, na.rm = TRUE), 
    # mean_nee          = sd(nee, na.rm = TRUE), 
    mean_le           = sd(le, na.rm = TRUE), 
    mean_h            = sd(h, na.rm = TRUE)
  )

summarize_dataset <- monthly_gpp %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  inner_join(ndvi_summarized) %>% 
  inner_join(biomet_summarized) %>% 
  drop_na()

set.seed(123)
gpp_split <- initial_split(summarize_dataset)
gpp_train <- training(gpp_split)
gpp_test <- testing(gpp_split)

set.seed(123)
gpp_boot <- bootstraps(gpp_train)
gpp_boot

rf_spec <- rand_forest() %>%
  set_mode("regression") %>%
  set_engine("ranger")

rf_spec

gpp_wf <- workflow() %>%
  add_formula(average_gpp ~ .)

gpp_wf


rf_rs <- gpp_wf %>%
  add_model(rf_spec) %>%
  fit_resamples(
    resamples = gpp_boot,
    control = control_resamples(save_pred = TRUE)
  )

rf_rs


## Evaluate model
collect_metrics(rf_rs)
```

## Conclusions

## References

> James, G., Witten, D., Hastie, T., & Tibshirani, R. (2013). An introduction to
> statistical learning (Vol. 112, p. 18). New York: springer.
