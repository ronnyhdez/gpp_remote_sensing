---
title: "Exploratory Data Analysis (EDA)"
description: |
  A description and graphical exploration of the datasets used in the research
site: distill::distill_website
output:
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(readr)
library(dplyr)
library(ggplot2)
library(janitor)
library(lubridate)
library(visdat)
library(corrplot)
library(tidyr)
library(rmarkdown)
library(report)


precipitation <- 
  read_csv("data/hardvard_dataverse_tropidry/Daily_Precipitation_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd(date),
         do_y = as.numeric(do_y),
         precip = as.numeric(precip))

biomet <- 
  read_csv("data/hardvard_dataverse_tropidry/Micrometeorological_Biomet_Parameters_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  mutate(date = ymd_hm(date)) %>% 
  mutate(across(where(is.character), as.numeric))

monthly_gpp <- 
  read_csv("data/hardvard_dataverse_tropidry/Monthly_NEE_GPP_Reco_2013_to_2016.csv") %>% 
  clean_names() %>% 
  slice(-1) %>% 
  unite(col = date, year, month, sep = "-") %>% 
  mutate(date = paste0(date, "-1"),
         date = ymd(date)) %>% 
  select(-date_1, -date_2) %>% 
  mutate(across(where(is.character), as.numeric))

ndvi_moha <- 
  readxl::read_xlsx("data/hardvard_dataverse_tropidry/final -NDVI- smoothed -complete.xlsx") %>% 
  clean_names()

modis_gpp <- 
  read_csv("data/modis-gpp-sr/modis-sr-MYD17A2H-006-results.csv") %>% 
  clean_names() %>% 
  select(date, myd17a2h_006_gpp_500m, 
         myd17a2h_006_psn_qc_500m_modland_description,
         myd17a2h_006_psn_qc_500m_cloud_state_description,
         myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  rename(gpp = myd17a2h_006_gpp_500m,
         modland_description = myd17a2h_006_psn_qc_500m_modland_description,
         cloud_state_description = myd17a2h_006_psn_qc_500m_cloud_state_description,
         scf_qc_description = myd17a2h_006_psn_qc_500m_scf_qc_description) %>% 
  mutate(gpp = gpp * 10)

modis_indices <- 
  read_csv("data/modis-indices-sr/modis-indices-sr-MOD13Q1-006-results.csv") %>% 
  clean_names() %>% 
  select(date, mod13q1_006_250m_16_days_evi, 
         mod13q1_006_250m_16_days_ndvi, 
         mod13q1_006_250m_16_days_vi_quality,
         mod13q1_006_250m_16_days_pixel_reliability,
         mod13q1_006_250m_16_days_pixel_reliability_modland_description) %>% 
  rename(evi = mod13q1_006_250m_16_days_evi,
         ndvi = mod13q1_006_250m_16_days_ndvi,
         vi_quality = mod13q1_006_250m_16_days_vi_quality,
         pixel_reliability = mod13q1_006_250m_16_days_pixel_reliability,
         reliability_modland_description =
           mod13q1_006_250m_16_days_pixel_reliability_modland_description)
```

## SRNP data exploration

Santa Rosa National Park Environmental Super Site in Guanacaste, Costa Rica
have several sensors to monitor environmental climate variables, radiation and
fluxes.

Given that variables such as NDVI and GPP can be calculate with instrumentation
in the site, this ones will be included and name as `in-situ_variable_name` to
differentiate them from the same variables obtained from the MODIS satellite
images.

| Dataset | Frequency | Date range |
| ------- | --------- | ---------- |
| Precipitation | Daily values | `2013-05-15 00:00:00 UTC` to `2017-05-17 23:30:00 UTC`|
| Meteorological data | Half hour values | `2013-05-15 00:00:00 UTC` to `2017-05-17 23:30:00 UTC` |
| Monthly Gross Primary Production (GPP) | Monthly values | `2013-05-01` to `2017-05-01`|
| NDVI (Normalized Difference Vegetation Index) | Daily values | `2013-02-23 UTC` to `2022-01-01 UTC`

### Santa Rosa Data tables glimpse

For Santa Rosa we have the following data sets:

#### Precipitation data

```{r}
precipitation %>% 
  slice(1:100) %>% 
  paged_table()
```

#### Meteorological data

```{r}
biomet %>% 
  slice(1:100) %>% 
  paged_table()
```

#### GPP in-situ data

```{r}
monthly_gpp %>% 
  slice(1:100) %>% 
  paged_table()
```

#### NDVI in-situ data

```{r}
ndvi_moha %>% 
  slice(1:100) %>% 
  paged_table()
```

### Precipitation EDA

```{r fig.cap = "Total precipitation (mm) for Santa Rosa National Park. Year 2015 had the lowest values of precicipitation"}
precipitation %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    total_precip = sum(precip, na.rm = TRUE)
  ) %>% 
  ggplot(aes(x = as.factor(year_mon), y = total_precip)) +
  geom_bar(stat = "identity") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "Date", y = "Total precipitation per month (mm)")
```


```{r fig.cap = "Total precipitation (mm) arrange per month for comparison per each year. Patterns for 2014 and 2015 as the months with less precipitation are more evident"}
### Agrupando los meses
precipitation %>%
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  filter(year(date) < 2017) %>% 
  group_by(year_mon) %>%
  summarize(
    total_precip = sum(precip, na.rm = TRUE)
  ) %>%
  mutate(year = year(year_mon),
         month = month(year_mon, label = TRUE)) %>%
  # mutate(year_mon = as.character(year_mon)) %>%
  ggplot(aes(x = as.factor(month), y = total_precip, fill = as.factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_light(base_size = 12) +
  scale_y_continuous(breaks = seq(0, 450, by = 50)) +
  scale_fill_viridis_d() +
  labs(x = "Date", y = "Total precipitation per month (mm)",
       fill = "Year")
```

### Environmental drivers

```{r fig.cap = "Seasonal pattern of VPD (hPa). Months asociated with lower precipitation rates have the highest values of VPD"}
biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  filter(vpd > 0) %>% 
  ggplot(aes(x = as.factor(year_mon), y = vpd, fill = as.factor(year_mon))) +
  stat_boxplot(geom = "errorbar", width = 0.25) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(-10, 40, by = 5)) +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  guides(fill = "none") +
  labs(x = "Date", y = "Vapor presurre deficit (hPa)")
```


```{r}
biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  # filter(vpd > 0) %>% 
  ggplot(aes(x = as.factor(year_mon), y = tair, fill = as.factor(year_mon))) +
  stat_boxplot(geom = "errorbar", width = 0.25) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(15, 38, by = 2)) +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  guides(fill = "none") +
  labs(x = "Date", y = "Air temperature (C)")
```


```{r}
biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  filter(le > 0) %>%
  ggplot(aes(x = as.factor(year_mon), y = le, fill = as.factor(year_mon))) +
  stat_boxplot(geom = "errorbar", width = 0.25) +
  geom_boxplot() +
  # scale_y_continuous(breaks = seq(15, 38, by = 2)) +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  guides(fill = "none") +
  labs(x = "Date", y = "Latent Heat (Wm-2)")
```


```{r}
biomet %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  # filter(le > 0) %>%
  ggplot(aes(x = as.factor(year_mon), y = r_h, fill = as.factor(year_mon))) +
  stat_boxplot(geom = "errorbar", width = 0.25) +
  geom_boxplot() +
  # scale_y_continuous(breaks = seq(15, 38, by = 2)) +
  scale_fill_viridis_d() +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  guides(fill = "none") +
  labs(x = "Date", y = "Relative Humidity (%)")
```

### NDVI

```{r}
ndvi_moha %>% 
  mutate(date = ymd(date)) %>% 
  filter(year(date) < 2017) %>% 
  ggplot(aes(x = date, y = ndvi)) +
  # geom_point(alpha = 0.5, color = "#FF3A1D", size = 3) +
  geom_jitter(alpha = 0.5, color = "#FF3A1D", size = 2.5) +
  theme_linedraw() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 90, h = 1))
```

### Monthly GPP

```{r}
monthly_gpp %>% 
  ggplot(aes(x = date, y = average_gpp, group = 1)) +
  geom_errorbar(aes(ymin = average_gpp - gpp_stdev,
                    ymax = average_gpp + gpp_stdev),
                colour = "#4D4D4D", width = .4) +
  geom_line(linetype = 2) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  theme_linedraw() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "Date", y = "GPP (mgm-2s-1)")
```

### Relation between in-situ NDVI and in-situ GPP

```{r}
ndvi_summarized <- ndvi_moha %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  group_by(year_mon) %>% 
  summarize(
    ndvi_mean = mean(ndvi, na.rm = TRUE),
    ndvi_sd = sd(ndvi, na.rm = TRUE)
  )

gpp_ndvi <- monthly_gpp %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  inner_join(ndvi_summarized) 

gpp_ndvi %>% 
  ggplot(aes(x = average_gpp, y = ndvi_mean)) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  theme_linedraw() +
  geom_smooth(method = "lm")


model <- lm(average_gpp ~ ndvi_mean, data = gpp_ndvi)
# summary(model)
report(model)
```

<!-- Puedo sacar la regresión lineal entre gpp y ndvi y con esta sacar los -->
<!-- distintos valores de gpp para cada día por ejemplo. -->
<!-- http://www.sthda.com/english/articles/40-regression-analysis/165-linear-regression-essentials-in-r/ -->

## MODIS data exploration

MODIS data collected for the site have 3 variables of interest:

 - NDVI
 - EVI
 - GPP

### MODIS Data tables glimpse

Data derived from satellite images for Santa Rosa is compose of following data
sets:

#### MODIS indices data

```{r}
modis_indices %>% 
  slice(1:100) %>% 
  paged_table()
```

#### MODIS GPP data

```{r}
modis_gpp %>% 
  slice(1:100) %>% 
  paged_table()
```

### GPP EDA

```{r}
modis_gpp %>% 
  ggplot(aes(x = date, y = gpp, group = 1)) +
  geom_line(linetype = 2) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  theme_linedraw() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "Date", y = "GPP (mgm-2s-1)")
```

### NDVI EDA

```{r}
modis_indices %>% 
  filter(reliability_modland_description !=
           "Marginal data, Useful, but look at other QA information") %>% 
  mutate(date = ymd(date)) %>% 
  filter(ndvi > 0.2) %>% 
  ggplot(aes(x = date, y = ndvi)) +
  geom_jitter(alpha = 0.7, color = "#FF3A1D", size = 3) +
  geom_line(linetype = 2) +
  theme_linedraw() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "Date", y = "NDVI")
```

### How many observations per month do we have?

```{r}
modis_indices %>% 
  group_by(zoo::as.yearmon(date)) %>% 
  tally() %>% 
  ggplot(aes(x = `zoo::as.yearmon(date)`, y = n)) +
  geom_col()

modis_gpp %>% 
  group_by(zoo::as.yearmon(date)) %>% 
  tally() %>% 
  ggplot(aes(x = `zoo::as.yearmon(date)`, y = n)) +
  geom_col()
```

### What is the relation between EVI NDVI & GPP MODIS products?

We are using products from MODIS which are: EVI, NDVI and GPP. These are already
calculated values that are available to users. These products comes with
variables that flags low quality values. In this case we have a data set with
flags for GPP and a data set with flags for the indices EVI and NDVI.

All values with flags that advertised low quality data points were remove from
both data sets. Then a pearson correlation was performed to explore the relation
between GPP and NDVI, and GPP with EVI.

```{r MODIS data quality filtering}
## Filter observations with good quality
## This takes from 94 observations to 53 observations. Remove 41 observations
modis_indices_clean <- modis_indices %>% 
  filter(reliability_modland_description == "Good data, use with confidence") %>% 
  select(date, ndvi, evi) #%>% 
  # mutate(week = week(date),
  #        year = year(date))

## Filter observations with good quality
## This takes from 183 observations to 114. Remove 69 observations.
modis_gpp_clean <- modis_gpp %>% 
  filter(modland_description == "Good quality",
         cloud_state_description == "Significant clouds NOT present (clear)",
         scf_qc_description == "Very best possible") %>% 
  select(date, gpp) #%>% 
  # mutate(week = week(date),
  #        year = year(date))

modis_join <- modis_gpp_clean %>% 
  full_join(modis_indices_clean, by = c("date"))
```

As validation for the relations between products from MODIS, I proceed to
compare NDVI and EVI against GPP to check how is the relation between these variables.

```{r, fig.cap = "Relation between NDVI and GPP products from MODIS for the Santa Rosa National Park"}
#### Relation between NDVI and GPP from MODIS
gpp_ndvi <- modis_join %>% 
  ggplot(aes(x = ndvi, y = gpp)) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  geom_smooth(method = "lm", color = "#4E5C68") +
  theme_light(base_size = 12) +
  # theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "NDVI", y = "GPP (mgm-2s-1)")

#### Relation between EVI and GPP from MODIS
gpp_evi <- modis_join %>% 
  ggplot(aes(x = evi, y = gpp)) +
  geom_point(color = "#FF3A1D", size = 3.5) +
  geom_smooth(method = "lm", color = "#4E5C68") +
  theme_light(base_size = 12) +
  # theme(axis.text.x = element_text(angle = 90, h = 1)) +
  labs(x = "EVI", y = "GPP (mg m-2 s-1)")

## Arrange both plots in one figure:
plot_grid(gpp_ndvi, gpp_evi, labels = c('A', 'B'), label_size = 12)
```

```{r corr results MODIS products}
ndvi_corr_test <- cor.test(modis_join$ndvi, modis_join$gpp)
evi_corr_test <- cor.test(modis_join$evi, modis_join$gpp)

# Check the report of the result
# report(ndvi_corr_test)
# report(evi_corr_test)
```

The Pearson's product-moment correlation between **NDVI and GPP** products from
MODIS is positive and statistically significant. (r = 0.81, 95% CI [0.65, 0.90],
t(34) = 8.01, p \< .001). For **EVI and GPP** the Pearson's product-moment
correlation is is positive, and statistically significant (r = 0.70, 95% CI
[0.48, 0.84], t(34) = 5.70, p \< .001)

-   NDVI have a higher positive correlation with GPP product from MODIS than
    EVI.

### MODIS NDVI, EVI & GPP trends over time

```{r fig.cap = "GPP trends over the years for MODIS and in-situ data. Despite having similar trends, range is higher for in-situ data than the MODIS derived GPP"}
# Plot with both GPP's
rec_monthly_gpp <- monthly_gpp %>% 
  select(date, average_gpp) %>% 
  rename(gpp = average_gpp) %>% 
  mutate(origin = "in_situ")

rec_modis_gpp <- modis_gpp %>% 
  select(date, gpp) %>% 
  mutate(date = floor_date(date, "month")) %>% 
  group_by(date) %>% 
  summarise(
    gpp = mean(gpp, na.rm = TRUE)
  ) %>% 
  mutate(origin = "modis") %>% 
  filter(date > ymd("2013-04-30"))

rec_both <- bind_rows(rec_monthly_gpp, rec_modis_gpp)

## Correlation trends between both GPP's`
rec_both %>% 
  ggplot(aes(x = date, y = gpp, group = origin)) +
  geom_line(aes(color = origin), size = 1) +
  theme_linedraw(base_size = 12) +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  theme(axis.text.x = element_text(angle = 70, h = 1)) +
  labs(x = "Date", y = "GPP (mgm-2s-1)", color = "GPP source")
```




## Summary

This is a bullet list with the main insights from the exploratory data analysis
that can help to understand the models and the phenomena explained in the
[Results and Discussion section](https://ronnyhdez.github.io/gpp_remote_sensing/results.html)

 - bla bla
